#!/usr/bin/env lua
--/bin/cpkg: Package manager for Cubix

_handler = {}
_handler.signal_handler = function (sig)
    if sig == 'kill' then
        --print("cpkg: recieved SIGKILL")
        return 0
    end
end

Package = {}
Package.__index = Package

function Package.new()
    local inst = {}
    setmetatable(inst, Package)
    inst.name = ''
    inst.version = ''
    inst.author = ''
    inst.fromdir = ''
    inst.instdir = ''
    inst.desc = ''
    return inst
end

function copyDirectory(from, to)
    local tList = fs.list(from)
    os.viewTable(tList)
    for k,v in ipairs(tList) do
        v = fs.combine(from, v)
        if fs.exists(v) then
            if fs.isDir(v) then
                --print("directory: "..v.." to ".. to)
                copyDirectory(v, to)
            elseif not fs.isDir(v) then
                print(v..' TO ' .. to)
                os.runfile("cp "..v.." "..to.."/")
            end
        end
    end
end

function Package:install()
    local _h = fs.open("/tmp/current_path", 'r')
    local CPATH = _h.readAll()
    _h.close()
    print("Installing "..self.name..'...')
    local lf = {}
    local pth = fs.combine(CPATH, self.fromdir.sub(1, #self.fromdir) .. '/' .. self.name)

    print("Installing from "..self.fromdir.sub(1, #self.fromdir) .. '/' .. self.name)
    copyDirectory(pth, '/usr/bin')
end

function remove_package(name)
    
end

function main(args)
    local p = args[1]
    if p == '-i' then
        --install package
        local file = args[2]
        local _h = fs.open("/tmp/current_path", 'r')
        local CPATH = _h.readAll() 
        _h.close()
        local h = {}
        if string.sub(file, 0, 1) == '/' and fs.exists(file) then
            h = fs.open(file, 'r')
        elseif fs.exists(fs.combine(CPATH, file)) then
            h = fs.open(fs.combine(CPATH, file), 'r')
        else
            os.ferror("cpkg: cannot open file")
            return 0
        end
        local pkg_resume = h.readAll()
        h.close()
        local package = Package.new()
        local pkg_data = os.strsplit(pkg_resume, '\n')
        for k,v in ipairs(pkg_data) do
            local data_split = os.strsplit(v, ';')
            local k = data_split[1]
            if k == 'Name' then
                package.name = data_split[2]
            elseif k == 'Version' then
                package.version = data_split[2]
            elseif k == 'Author' then
                package.author = data_split[2]
            elseif k == 'From' then
                package.fromdir = data_split[2]
            elseif k == 'To' then
                package.instdir = data_split[2]
            elseif k == 'Description' then
                package.desc = data_split[2]
            end
        end
        --os.viewTable(package)
        package:install()
    elseif p == '-r' then
        --remove package
        local pkgname = args[1]
        remove_package(pkgname)
    elseif p == '-V' then
        --verify package
    elseif p == '' then
    elseif p == '' then
    elseif p == '' then
    elseif p == '' then
    elseif p == '' then
    end
end

