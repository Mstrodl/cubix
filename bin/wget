#!/usr/bin/env lua
--/bin/wget
--TODO: download files using HTTP

_handler = {}
_handler.signal_handler = function (sig)
    if sig == 'kill' then
        --print("wget: recieved SIGKILL")
        return 0
    end
end

if not http then
    os.ferror("wget: cannot use HTTP API, closing.")
    return 0
end

function usage()
    print("usage: wget <url> <file>")
end

function download_file(url)
    http.request(url)
    local req = true
    while req do
        local e, url, stext = os.pullEvent()
        if e == 'http_success' then
            local rText = stext.readAll()
            stext.close()
            return rText
        elseif e == 'http_failure' then
            req = false
            return {false, 'http_failure'}
        end
    end
end

function main(args)
    if #args == 0 then
        usage()
        return 0
    end
    --[[local url, dest = args[1], args[2]
    local response = http.get(url)
    local sResponse = ''
    if response then
        print("wget: GET success")
        sResponse = response.readAll()
        response.close()
    else
        os.ferror("wget: failed!")
    end
    ]]

    local url, destination = args[1], args[2]
    local response = download_file(url)
    if type(response) == 'string' then
        print("wget: REQUEST OK")
    else
        os.ferror("wget: type(response) ~= string")
        os.ferror("wget: "..response[2])
        return 1
    end

    local _h = fs.open("/tmp/current_path", 'r')
    local CPATH = _h.readAll()
    _h.close()

    local fh = {}
    if string.sub(dest, 0, 1) == '/' then
        fh = fs.open(dest, 'w')
    elseif not fs.exists(fs.combine(CPATH, dest)) then
        fh = fs.open(fs.combine(CPATH, dest), 'w')
    else
        fh = fs.open(fs.combine(CPATH, dest), 'w')
    end

    fh.write(response)
    fh.close()

    print("wget: downloaded as "..dest.. " from "..url)
    return 0
end
