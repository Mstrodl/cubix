#!/usr/bin/env lua
--/bin/tee: same as unix tee
--the Cubix Shell does not support any pipes, so tee doesn't work.
--this is just an ideia of how tee could work with pipes

_handler = {}
_handler.signal_handler = function (sig)
    if sig == 'kill' then
        --print("tee: recieved SIGKILL")
        return 0
    end
end

if os.loadAPI("/lib/pipe_manager") then
    pipemngr = _G["pipe_manager"]
    os.debug.debug_write("[tee] pipe_manager: loaded", false)
else
    os.debug.debug_write("[tee] pipe_manager: not loaded")
end

function main(args, pipe)
    --cmd1 | tee output_file | cmd2
    local hpipe = pipemngr.Pipe.copyPipe(pipe)
    local from = ''
    while true do
        local line = hpipe:readLine()
        if not line or line == '' then break end
        from = from .. line .. '\n'
    end

    local _h = fs.open("/tmp/current_path", 'r')
    local CPATH = _h.readAll()
    _h.close()
    local file = args[1]
    local h = {}

    if string.sub(file, 0, 1) == '/' then
        h = fs.open(file, 'w')
    elseif not fs.exists(fs.combine(CPATH, file)) then
        h = fs.open(fs.combine(CPATH, file), 'w')
    else
        os.ferror("tee: cannot write to path")
        return 0
    end

    h.write(from)
    h.close()
    return 0
end
