#!/usr/bin/env lua
--/bin/sudo: grants access to run programs in /sbin
-- so, yes, Cubix has some security flaws, and one of these flaws is
-- to run /sbin programs using os.runfile, and shell does not give a
-- single fuck to Cubix permissions, only /bin/cshell uses some kind of
-- "if you're root, i will run, if not, fuck you" strategy
-- and this is not good because of the point described here
-- and because of this point sudo can be created without fs_manager
-- craziness.

_handler = {}
_handler.signal_handler = function (sig)
    if sig == 'kill' then
        os.debug.debug_write("sudo: SIGKILL'd!", false)
        return 0
    end
end

function main(_args)
    local current_user = os.lib.login.currentUser()
    local current_token = os.lib.login.__CT

    local isValid = current_token:verifyValid()

    -- if os.currentUID() == 0 then
    --     run_program()
    -- end

    if not isValid then
        if not os.lib.login.front_login('sudo') then
            os.ferror("sudo: Login incorrect")
            return 0
        end
    else
        if not os.lib.login.isSudo() then
            if not os.lib.login.front_login('sudo') then
                os.ferror("sudo: Login incorrect")
                return 0
            end
        else
            current_token:use()
        end
    end

--[[
    if not permission.grantAccess(fs.perms.ROOT) then
        os.ferror("permission: error getting root permission")
        return 0
    end
]]

    local program = _args[1]
    if program == nil then return 0 end
    local args = os.tail(_args)

    local h = fs.open("/tmp/current_path", 'r')
    local current_path = h.readAll()
    h.close()

    local found = false
    if fs.exists(program) then
        found = true
        os.runfile_proc(program, args)
    elseif fs.exists(fs.combine(current_path, program)) then
        found = true
        os.runfile_proc(fs.combine(current_path, program), args)
    end

    local _path = os.strsplit(os.cshell.PATH, ':')
    for k,v in ipairs(_path) do
        local K = fs.combine(v..'/', program)
        if fs.exists(K) then
            found = true
            os.runfile_proc(K, args)
        end
    end

    if fs.exists(fs.combine("/sbin/", program)) then
        found = true
        os.runfile_proc(fs.combine("/sbin/", program), args)
    end
    if not found then
        os.ferror("sudo: Program not found")
    end
    return 0
end
