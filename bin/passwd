#!/usr/bin/env lua
--/bin/passwd: change user password

_handler = {}
_handler.signal_handler = function(sig)
    if sig == 'kill' then
        --print("passwd: SIGKILL")
        return 0
    end
end

function main(args)
    local u = args[1]
    local fcu = fs.open("/tmp/current_user", 'r')
    local cu = fcu.readAll()
    fcu.close()
    if u == nil then
        u = cu
    end
    if cu ~= 'root' and u == 'root' then
        os.ferror("passwd: you're not allowed to change root password, unless you get root access!")
        return 0
    end
    print("changing password from "..u)
    write(u.." password: ")
    local apwd = read('')
    write('\n')
    if os.lib.login.login(u, apwd) then
        write("new "..u.." password: ")
        local npwd = read('')
        write('\n')
        if os.lib.login.changepwd(u, apwd, npwd) then
            print("changed password of "..u)
            return 0
        else
            os.ferror("passwd: error ocourred when calling changepwd()")
            return 1
        end
    else
        os.ferror("passwd: Authentication Error")
        os.ferror("passwd: password unaltered")
    end
    return 0
end
